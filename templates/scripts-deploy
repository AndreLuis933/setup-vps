#!/usr/bin/env bash
# Copy this file to your project's scripts/deploy
# Make it executable: chmod +x scripts/deploy
#
# Contract:
#   The watcher service already runs `git fetch` + `git reset --hard` before
#   calling this script, so you do NOT need any git operations here.
#
# Required .env variables (loaded by the watcher before calling this script):
#   CURRENT_ENV     - "production" or "development"
#   DEPLOY_BRANCH   - branch name (e.g., "main")

set -Eeuo pipefail

catch_errors() {
  local rc=$?
  printf '\nERROR:\nsrc=%s\nline=%s\nrc=%s\ncmd=%b\n\n' \
    "${BASH_SOURCE[0]}" "$LINENO" "$rc" "$BASH_COMMAND" >&2
  exit "$rc"
}

trap catch_errors ERR

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# TODO: If you don't use the VPS backup_volumes script, remove these lines
# /bin/bash -c "'${PROJECT_ROOT}/data/scripts/backup_volumes' before_$(git rev-parse --short HEAD)"

# Pull latest images and restart containers
docker compose pull --policy always
docker compose up -d --remove-orphans

# TODO: Add post-deploy hooks here. Examples:
# docker compose exec app python manage.py migrate --noinput
# docker compose exec app python manage.py collectstatic --noinput
# docker compose exec app npm run db:seed

# Clean up dangling images
docker image prune -f

# TODO: If you don't use the VPS backup_volumes script, remove these lines
# /bin/bash -c "'${PROJECT_ROOT}/data/scripts/backup_volumes' after_$(git rev-parse --short HEAD)"

echo "OK: deployed $(git rev-parse --short HEAD)"
