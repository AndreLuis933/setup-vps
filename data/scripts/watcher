#!/usr/bin/env bash
# vim:sw=2:ts=2:et:set filetype=bash :

# ################################################################################
# # Author: Luiz Ot√°vio Miranda <luizomf@gmail.com>
# # Date: 2026-01-13
# # License: MIT
# ################################################################################

set -u

PARENT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}" || exit)" && pwd)"
INTERVAL=60 # (Seconds) Check interval


# Webhook Jobs Directory (Inside the shared volume)
WEBHOOKS_JOBS_DIR="/data/webhook_jobs"

# The job runs in the host server. The lock file path refers to the host.
LOCK_FILE="/tmp/webhook_deploy.lock"

echo "Watcher started. Lock file: $LOCK_FILE"

while true; do
  # Check if there are any folders in the directory
  HAS_JOBS=$(docker exec data_vol sh -c "ls -A ${WEBHOOKS_JOBS_DIR} | head -n 1")

  if [[ -z "$HAS_JOBS" ]]; then
    # No jobs, sleep and retry based on the INTERVAL
    sleep $INTERVAL
    continue
  fi

  # Jobs found! Let's acquire the lock to ensure atomic execution.
  (
    flock -n 200 || exit 1 # <- HELLO GIL üòÇ

    curr_date=$(date "+%s")
    echo "[$curr_date] Jobs detected! Locking and starting deploy sequence..."

    # Pega a primeira pasta encontrada
    JOB_FOLDER=$(docker exec data_vol sh -c "find ${WEBHOOKS_JOBS_DIR} -mindepth 1 -maxdepth 1 -type d | head -n 1")

    if [[ -z "$JOB_FOLDER" ]]; then
      echo "[$curr_date] No valid job folder found."
      exit 0
    fi

    # Extrai o nome da pasta
    JOB_NAME=$(basename "$JOB_FOLDER")
    echo "[$curr_date] Processing job: $JOB_NAME"

    # Determina qual script executar baseado no nome da pasta
    DEPLOY_SCRIPT="/projects/${JOB_NAME}/scripts/deploy"

    if [[ ! -f "$DEPLOY_SCRIPT" ]]; then
      echo "[$curr_date] Deploy script not found: $DEPLOY_SCRIPT. Skipping..."
      docker exec data_vol sh -c "rm -rf ${JOB_FOLDER}"
      exit 0
    fi

    echo "[$curr_date] Running deploy script: $DEPLOY_SCRIPT"

    if /bin/bash "$DEPLOY_SCRIPT"; then
        echo "[$(date "+%s")] Deploy success for $JOB_NAME."
    else
        echo "[$(date "+%s")] Deploy failed for $JOB_NAME."
        # Optional: Send notification to Discord/Slack here
    fi

    # Apaga APENAS a pasta do job executado
    echo "[$curr_date] Removing job folder: $JOB_FOLDER"
    docker exec data_vol sh -c "rm -rf ${JOB_FOLDER}"

  ) 200>"$LOCK_FILE"

  # If flock exited with 1, it means another instance is running.
  if [ $? -eq 1 ]; then
      echo "[$(date "+%s")] Deploy already in progress. Skipping..."
  fi

  sleep $INTERVAL
done

################################################################################

# Instructions
# sudo vim /etc/systemd/system/webhook-watcher.service
#
# [Unit]
# Description=Webhook Watcher for Docker Deployment
# After=network.target
#
# [Service]
# Type=simple
# WorkingDirectory=/dockerlabs/
# ExecStart=/dockerlabs/data/scripts/watcher
# Restart=always
# RestartSec=3
# User=luizotavio
# Group=luizotavio
#
# [Install]
# WantedBy=multi-user.target
#

################################################################################

# # Commands to create
# sudo systemctl daemon-reload
# sudo systemctl enable webhook-watcher
# sudo systemctl start webhook-watcher
# sudo systemctl status webhook-watcher
#
# Commands to remove
# sudo systemctl stop webhook-watcher
# sudo systemctl disable webhook-watcher
# sudo rm /etc/systemd/system/webhook-watcher.service
# sudo systemctl daemon-reload
# # If it insists
# sudo systemctl reset-failed
#
# Check journal live (logs)
# sudo journalctl -u webhook-watcher.service -f
#

################################################################################